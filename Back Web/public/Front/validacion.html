
<html>
<head>
    <title>Validaci√≥n del Sistema</title>
</head>
<body>
    <h1>üîç Validador del Sistema de Restaurante</h1>
    <button onclick="ejecutarValidacion()" style="padding: 10px 20px; font-size: 16px;">
        üöÄ Ejecutar Validaci√≥n Completa
    </button>
    <button onclick="validacionRapida()" style="padding: 10px 0px; font-size: 16px;">
        ‚ö° Validaci√≥n R√°pida
    </button>
    
    <div id="resultados" style="margin-top: 20px; padding: 10px; background: #f5f5f5;">
        <p>Presiona un bot√≥n para iniciar la validaci√≥n...</p>
    </div>

    <script>


// SCRIPT DE VALIDACI√ìN Y PRUEBA DEL SISTEMA COMPLETO
// Ejecutar este script para validar que todos los componentes est√©n funcionando

class SistemaValidator {
  constructor() {
    this.API_BASE_URL = 'http://192.1.1.16:3000/api';
    this.errores = [];
    this.warnings = [];
    this.exitos = [];
  }

  // ==========================================
  // VALIDACI√ìN COMPLETA DEL SISTEMA
  // ==========================================
  async validarSistemaCompleto() {
    console.log('üöÄ === INICIANDO VALIDACI√ìN COMPLETA DEL SISTEMA ===');
    
    try {
      // 1. Validar conexi√≥n con backend
      await this.validarConexionBackend();
      
      // 2. Validar endpoints de mesas
      await this.validarEndpointsMesas();
      
      // 3. Validar endpoints de √≥rdenes
      await this.validarEndpointsOrdenes();
      
      // 4. Validar endpoints de men√∫
      await this.validarEndpointsMenu();
      
      // 5. Prueba de flujo completo
      await this.pruebaFlujoCompleto();
      
      // 6. Mostrar resultados
      this.mostrarResultados();
      
      return {
        success: this.errores.length === 0,
        errores: this.errores,
        warnings: this.warnings,
        exitos: this.exitos
      };
      
    } catch (error) {
      console.error('‚ùå Error durante la validaci√≥n:', error);
      this.errores.push(`Error general: ${error.message}`);
      this.mostrarResultados();
      return { success: false, error: error.message };
    }
  }

  // ==========================================
  // VALIDACIONES ESPEC√çFICAS
  // ==========================================
  async validarConexionBackend() {
    console.log('\nüîç 1. VALIDANDO CONEXI√ìN CON BACKEND...');
    
    try {
      const response = await fetch(`${this.API_BASE_URL}/health`, {
        method: 'GET',
        timeout: 10000
      });
      
      if (response.ok) {
        const data = await response.json();
        this.exitos.push('‚úÖ Conexi√≥n con backend establecida');
        console.log('‚úÖ Backend responde correctamente');
        return true;
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      this.errores.push(`‚ùå Backend no responde: ${error.message}`);
      console.error('‚ùå Backend no responde:', error.message);
      return false;
    }
  }

  async validarEndpointsMesas() {
    console.log('\nü™ë 2. VALIDANDO ENDPOINTS DE MESAS...');
    
    const endpoints = [
      { method: 'GET', path: '/mesas', name: 'Obtener mesas' },
      { method: 'POST', path: '/mesas', name: 'Crear mesa', body: {
        nombre: 'Mesa Test',
        numero: 999,
        capacidad: 4,
        tipo: 'mesa',
        ubicacion: 'Test'
      }}
    ];
    
    for (const endpoint of endpoints) {
      try {
        const options = {
          method: endpoint.method,
          headers: { 'Content-Type': 'application/json' }
        };
        
        if (endpoint.body) {
          options.body = JSON.stringify(endpoint.body);
        }
        
        const response = await fetch(`${this.API_BASE_URL}${endpoint.path}`, options);
        
        if (response.ok) {
          this.exitos.push(`‚úÖ ${endpoint.name} - OK`);
          console.log(`‚úÖ ${endpoint.name} funciona correctamente`);
          
          // Si fue crear mesa, intentar eliminar la mesa de prueba
          if (endpoint.method === 'POST') {
            const data = await response.json();
            if (data.mesa?.id || data.id) {
              await this.limpiarMesaPrueba(data.mesa?.id || data.id);
            }
          }
        } else {
          this.warnings.push(`‚ö†Ô∏è ${endpoint.name} - HTTP ${response.status}`);
          console.log(`‚ö†Ô∏è ${endpoint.name} devolvi√≥ HTTP ${response.status}`);
        }
      } catch (error) {
        this.errores.push(`‚ùå ${endpoint.name} - ${error.message}`);
        console.error(`‚ùå ${endpoint.name}:`, error.message);
      }
    }
  }

  async validarEndpointsOrdenes() {
    console.log('\nüçΩÔ∏è 3. VALIDANDO ENDPOINTS DE √ìRDENES...');
    
    const endpoints = [
      { method: 'GET', path: '/ordenes/activas', name: '√ìrdenes activas' },
      { method: 'POST', path: '/ordenes/quick', name: 'Crear orden r√°pida', body: {
        mesa: 'Mesa Test',
        items: [{
          menu_item_id: 1,
          cantidad: 1,
          precio: 10000,
          nombre: 'Test Item'
        }],
        total: 10000,
        cliente: 'Test Cliente'
      }}
    ];
    
    for (const endpoint of endpoints) {
      try {
        const options = {
          method: endpoint.method,
          headers: { 'Content-Type': 'application/json' }
        };
        
        if (endpoint.body) {
          options.body = JSON.stringify(endpoint.body);
        }
        
        const response = await fetch(`${this.API_BASE_URL}${endpoint.path}`, options);
        
        if (response.ok) {
          const data = await response.json();
          this.exitos.push(`‚úÖ ${endpoint.name} - OK`);
          console.log(`‚úÖ ${endpoint.name} funciona correctamente`);
          
          // Guardar ID de orden para pruebas posteriores
          if (endpoint.method === 'POST' && data.orden?.id) {
            this.ordenPruebaId = data.orden.id;
          }
        } else {
          this.warnings.push(`‚ö†Ô∏è ${endpoint.name} - HTTP ${response.status}`);
          console.log(`‚ö†Ô∏è ${endpoint.name} devolvi√≥ HTTP ${response.status}`);
        }
      } catch (error) {
        this.errores.push(`‚ùå ${endpoint.name} - ${error.message}`);
        console.error(`‚ùå ${endpoint.name}:`, error.message);
      }
    }
  }

  async validarEndpointsMenu() {
    console.log('\nüçΩÔ∏è 4. VALIDANDO ENDPOINTS DE MEN√ö...');
    
    const endpoints = [
      { method: 'GET', path: '/menu', name: 'Obtener men√∫' },
      { method: 'GET', path: '/menu/categorias', name: 'Obtener categor√≠as' },
      { method: 'GET', path: '/menu/especiales', name: 'Obtener especiales' }
    ];
    
    for (const endpoint of endpoints) {
      try {
        const response = await fetch(`${this.API_BASE_URL}${endpoint.path}`);
        
        if (response.ok) {
          const data = await response.json();
          this.exitos.push(`‚úÖ ${endpoint.name} - OK`);
          console.log(`‚úÖ ${endpoint.name} funciona correctamente`);
          
          // Validar estructura de datos
          if (Array.isArray(data)) {
            console.log(`   üìä Datos obtenidos: ${data.length} items`);
          }
        } else {
          this.warnings.push(`‚ö†Ô∏è ${endpoint.name} - HTTP ${response.status}`);
          console.log(`‚ö†Ô∏è ${endpoint.name} devolvi√≥ HTTP ${response.status}`);
        }
      } catch (error) {
        this.errores.push(`‚ùå ${endpoint.name} - ${error.message}`);
        console.error(`‚ùå ${endpoint.name}:`, error.message);
      }
    }
  }

  async pruebaFlujoCompleto() {
    console.log('\nüîÑ 5. PRUEBA DE FLUJO COMPLETO...');
    
    try {
      // 1. Crear mesa
      console.log('   üìù Creando mesa de prueba...');
      const mesaResponse = await fetch(`${this.API_BASE_URL}/mesas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nombre: 'Mesa Flujo Test',
          numero: 888,
          capacidad: 4,
          tipo: 'mesa',
          ubicacion: 'Test Zone'
        })
      });
      
      let mesaId = null;
      if (mesaResponse.ok) {
        const mesaData = await mesaResponse.json();
        mesaId = mesaData.mesa?.id || mesaData.id;
        this.exitos.push('‚úÖ Mesa de prueba creada');
        console.log('   ‚úÖ Mesa creada correctamente');
      } else {
        throw new Error('No se pudo crear mesa de prueba');
      }
      
      // 2. Crear orden para la mesa
      console.log('   üçΩÔ∏è Creando orden de prueba...');
      const ordenResponse = await fetch(`${this.API_BASE_URL}/ordenes/quick`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mesa: 'Mesa Flujo Test',
          items: [{
            menu_item_id: 1,
            cantidad: 1,
            precio: 15000,
            nombre: 'Plato de Prueba'
          }],
          total: 15000,
          cliente: 'Cliente Flujo Test'
        })
      });
      
      let ordenId = null;
      if (ordenResponse.ok) {
        const ordenData = await ordenResponse.json();
        ordenId = ordenData.orden?.id;
        this.exitos.push('‚úÖ Orden de prueba creada');
        console.log('   ‚úÖ Orden creada correctamente');
      } else {
        throw new Error('No se pudo crear orden de prueba');
      }
      
      // 3. Cambiar estado de mesa
      if (mesaId) {
        console.log('   üîÑ Probando cambio de estado de mesa...');
        const estadoResponse = await fetch(`${this.API_BASE_URL}/mesas/${mesaId}/estado`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estado: 'ocupada' })
        });
        
        if (estadoResponse.ok) {
          this.exitos.push('‚úÖ Cambio de estado de mesa funciona');
          console.log('   ‚úÖ Estado de mesa cambiado correctamente');
        } else {
          this.warnings.push('‚ö†Ô∏è Cambio de estado de mesa fall√≥');
        }
      }
      
      // 4. Cambiar estado de orden
      if (ordenId) {
        console.log('   üîÑ Probando cambio de estado de orden...');
        const estadoOrdenResponse = await fetch(`${this.API_BASE_URL}/ordenes/${ordenId}/estado`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estado: 'preparando' })
        });
        
        if (estadoOrdenResponse.ok) {
          this.exitos.push('‚úÖ Cambio de estado de orden funciona');
          console.log('   ‚úÖ Estado de orden cambiado correctamente');
        } else {
          this.warnings.push('‚ö†Ô∏è Cambio de estado de orden fall√≥');
        }
      }
      
      // 5. Limpiar datos de prueba
      await this.limpiarDatosPrueba(mesaId, ordenId);
      
    } catch (error) {
      this.errores.push(`‚ùå Flujo completo fall√≥: ${error.message}`);
      console.error('‚ùå Error en flujo completo:', error.message);
    }
  }

  // ==========================================
  // FUNCIONES DE LIMPIEZA
  // ==========================================
  async limpiarMesaPrueba(mesaId) {
    try {
      const response = await fetch(`${this.API_BASE_URL}/mesas/${mesaId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        console.log('   üßπ Mesa de prueba eliminada');
      }
    } catch (error) {
      console.log('   ‚ö†Ô∏è No se pudo eliminar mesa de prueba:', error.message);
    }
  }

  async limpiarDatosPrueba(mesaId, ordenId) {
    console.log('   üßπ Limpiando datos de prueba...');
    
    // Limpiar orden (marcar como cancelada)
    if (ordenId) {
      try {
        await fetch(`${this.API_BASE_URL}/ordenes/${ordenId}/estado`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estado: 'cancelada' })
        });
      } catch (error) {
        console.log('   ‚ö†Ô∏è No se pudo cancelar orden de prueba');
      }
    }
    
    // Limpiar mesa
    if (mesaId) {
      await this.limpiarMesaPrueba(mesaId);
    }
  }

  // ==========================================
  // MOSTRAR RESULTADOS
  // ==========================================
  mostrarResultados() {
    console.log('\nüìã === RESULTADOS DE LA VALIDACI√ìN ===');
    
    console.log(`\n‚úÖ √âXITOS (${this.exitos.length}):`);
    this.exitos.forEach(exito => console.log(`  ${exito}`));
    
    if (this.warnings.length > 0) {
      console.log(`\n‚ö†Ô∏è ADVERTENCIAS (${this.warnings.length}):`);
      this.warnings.forEach(warning => console.log(`  ${warning}`));
    }
    
    if (this.errores.length > 0) {
      console.log(`\n‚ùå ERRORES (${this.errores.length}):`);
      this.errores.forEach(error => console.log(`  ${error}`));
    }
    
    console.log('\nüéØ === RESUMEN FINAL ===');
    if (this.errores.length === 0) {
      console.log('‚úÖ SISTEMA FUNCIONANDO CORRECTAMENTE');
      console.log('   Todos los componentes principales est√°n operativos');
      
      if (this.warnings.length > 0) {
        console.log('‚ö†Ô∏è Hay algunas advertencias menores que revisar');
      }
    } else {
      console.log('‚ùå SISTEMA CON PROBLEMAS');
      console.log('   Se encontraron errores cr√≠ticos que deben resolverse');
      
      // Mostrar recomendaciones
      console.log('\nüí° RECOMENDACIONES:');
      
      if (this.errores.some(e => e.includes('Backend no responde'))) {
        console.log('  1. Verificar que el servidor backend est√© ejecut√°ndose');
        console.log('  2. Confirmar la URL del servidor: http://200.54.216.197:3000');
        console.log('  3. Verificar conexi√≥n de red');
      }
      
      if (this.errores.some(e => e.includes('HTTP 404'))) {
        console.log('  4. Algunos endpoints no est√°n implementados');
        console.log('  5. Verificar las rutas en el servidor');
      }
      
      if (this.errores.some(e => e.includes('HTTP 500'))) {
        console.log('  6. Error interno del servidor');
        console.log('  7. Revisar logs del backend');
        console.log('  8. Verificar conexi√≥n a base de datos');
      }
    }
    
    console.log('\nüìä ESTAD√çSTICAS:');
    console.log(`  ‚úÖ √âxitos: ${this.exitos.length}`);
    console.log(`  ‚ö†Ô∏è Advertencias: ${this.warnings.length}`);
    console.log(`  ‚ùå Errores: ${this.errores.length}`);
    console.log(`  üìà Porcentaje de √©xito: ${Math.round((this.exitos.length / (this.exitos.length + this.warnings.length + this.errores.length)) * 100)}%`);
  }

  // ==========================================
  // VALIDACI√ìN ESPEC√çFICA DE APISERVICE
  // ==========================================
  static validarApiService() {
    console.log('\nüîç VALIDANDO APISERVICE...');
    
    // Verificar que ApiService tenga todos los m√©todos necesarios
    const metodosRequeridos = [
      'getMesas',
      'createMesa', 
      'updateMesa',
      'updateEstadoMesa', // ‚úÖ M√âTODO CR√çTICO FALTANTE
      'deleteMesa',
      'getEstadisticasMesas',
      'createPedido',
      'getOrdenesActivas',
      'updateEstadoOrden',
      'updateEstadoItem'
    ];
    
    const apiServiceContent = `
      // Verificar si ApiService tiene los m√©todos requeridos
      if (typeof ApiService !== 'undefined') {
        const metodosPresentes = [];
        const metodosFaltantes = [];
        
        ${metodosRequeridos.map(metodo => `
          if (typeof ApiService.${metodo} === 'function') {
            metodosPresentes.push('${metodo}');
          } else {
            metodosFaltantes.push('${metodo}');
          }
        `).join('')}
        
        console.log('‚úÖ M√©todos presentes:', metodosPresentes);
        if (metodosFaltantes.length > 0) {
          console.log('‚ùå M√©todos faltantes:', metodosFaltantes);
          return false;
        }
        return true;
      } else {
        console.log('‚ùå ApiService no est√° definido');
        return false;
      }
    `;
    
    console.log('üìã M√©todos requeridos en ApiService:');
    metodosRequeridos.forEach(metodo => {
      console.log(`  - ${metodo}`);
    });
    
    return apiServiceContent;
  }
}

// ==========================================
// EJECUCI√ìN AUTOM√ÅTICA Y EXPORT
// ==========================================

// Funci√≥n principal para ejecutar validaci√≥n
async function ejecutarValidacion() {
  const validator = new SistemaValidator();
  const resultado = await validator.validarSistemaCompleto();
  
  return resultado;
}

// Funci√≥n de validaci√≥n r√°pida
async function validacionRapida() {
  console.log('‚ö° VALIDACI√ìN R√ÅPIDA DEL SISTEMA');
  
  try {
    // Probar conexi√≥n b√°sica
    const response = await fetch('http://192.1.1.16:3000/api/health');
    if (response.ok) {
      console.log('‚úÖ Backend conectado');
      
      // Probar endpoint cr√≠tico
      const ordenesResponse = await fetch('http://192.1.1.16:3000/api/ordenes/activas');
      if (ordenesResponse.ok) {
        console.log('‚úÖ Endpoint de √≥rdenes activas funcionando');
        return true;
      } else {
        console.log('‚ùå Endpoint de √≥rdenes activas fall√≥');
        return false;
      }
    } else {
      console.log('‚ùå Backend no responde');
      return false;
    }
  } catch (error) {
    console.log('‚ùå Error de conexi√≥n:', error.message);
    return false;
  }
}

// Export para uso en React Native o browser
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { SistemaValidator, ejecutarValidacion, validacionRapida };
} else if (typeof window !== 'undefined') {
  window.SistemaValidator = SistemaValidator;
  window.ejecutarValidacion = ejecutarValidacion;
  window.validacionRapida = validacionRapida;
}

console.log('‚úÖ Sistema de validaci√≥n cargado. Ejecutar con: ejecutarValidacion()');

// Auto-ejecutar si est√° en browser y no es producci√≥n
if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
  console.log('üöÄ Auto-ejecutando validaci√≥n en entorno de desarrollo...');
  setTimeout(ejecutarValidacion, 2000);
}

 async function mostrarValidacion() {
            document.getElementById('resultados').innerHTML = '<p>üîÑ Ejecutando validaci√≥n...</p>';
            
            try {
                const resultado = await ejecutarValidacion();
                
                let html = '<h3>üìã Resultados:</h3>';
                html += `<p><strong>Estado:</strong> ${resultado.success ? '‚úÖ √âXITO' : '‚ùå ERRORES'}</p>`;
                
                if (resultado.exitos?.length > 0) {
                    html += '<h4>‚úÖ √âxitos:</h4><ul>';
                    resultado.exitos.forEach(exito => {
                        html += `<li>${exito}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (resultado.errores?.length > 0) {
                    html += '<h4>‚ùå Errores:</h4><ul>';
                    resultado.errores.forEach(error => {
                        html += `<li style="color: red;">${error}</li>`;
                    });
                    html += '</ul>';
                }
                
                document.getElementById('resultados').innerHTML = html;
                
            } catch (error) {
                document.getElementById('resultados').innerHTML = 
                    `<p style="color: red;">‚ùå Error ejecutando validaci√≥n: ${error.message}</p>`;
            }
        }
        
        // Sobrescribir funci√≥n para mostrar en p√°gina
        window.ejecutarValidacion = mostrarValidacion;
        
        // Validaci√≥n r√°pida
        window.validacionRapida = async function() {
            document.getElementById('resultados').innerHTML = '<p>‚ö° Ejecutando validaci√≥n r√°pida...</p>';
            
            try {
                const resultado = await validacionRapida();
                const estado = resultado ? '‚úÖ Sistema funcionando' : '‚ùå Sistema con problemas';
                document.getElementById('resultados').innerHTML = `<p><strong>${estado}</strong></p>`;
            } catch (error) {
                document.getElementById('resultados').innerHTML = 
                    `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>